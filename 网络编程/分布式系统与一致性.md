##《分布式系统与一致性》

无状态服务器：应用服务器中不再保存任何数据；数据全部保存在专门的数据库服务器



### 系统架构变迁

单机

垂直

水平



分布式特性：一致性、可扩展、容错、高可用等

其中一致性最为重要的，一致性的变动会连带影响其他特性





### Paxos算法（共识算法）

proposer：提出value

acceptor：会**保存**确定下来的value

paxos在于多个acceptor之间达成某种共识，而不是在于proposer，而且也只有acceptor才会存储这个共识



#### Basic Paxos（paxos consensus algorithm）

**一次paxos consensus只能批准一个value！！！- - 达成共识（这也是最终目的所在！）**，但每次paxos consensus有多轮，只要最终的学习值阶段没有达成所有的一致，就继续一轮一轮的做下去。

#####选择值（2阶段4步）：

**值（value）代表的是某种操作，而不是简单的一个字面意义上的变量**，而且可以是任意操作，例如“修改某个变量的值为某个值”、“设置当前 primary 为某个节点”等。Paxos协议中统一将这些操作抽象为 value。

选择值过程是proposer和大多数（majority）的acceptor之间的交互 

1a. proposer向majority acceptor 提出prepare request，并声明当前提议号n

1b. acceptor收到prepare后，检查是否response过更高的prepare，否则回复proposer：承诺不会接受提议号小于n的提议；同时返回已接受的最大的提议（含提议号和提议值）-如果有的话，没有就返回null；promise(n,an,av)

2a. proposer收到半数以上acceptor的promise后，发出accept request(n, v)，但其中的值有两种：

1）收到的promise全部都是null，即acceptor都没有接受过其他提议，则可自由任选值

2）收到的promise中有已接受的值，则后者认可前者，将值替换为接受的小于n的提议中最大的提议值

2b. 收到提议号为n的accept  request后，如果没有回复过其他更高的提议号就接受该值（存储），否则拒绝该请求

（有些类似于两阶段提交的概念？？）

最后一步的acceptor收到accept request后存储新值（表明被批准accepted了），不需要验证是大多数acceptor收到了，可能只有一个acceptor收到了；不过在之后的学习值过程中会要求大多数的acceptor给learner发送了值，从而反向验证了收到accept request并存储下来的acceptor是majority



1、选择值的过程中，可能导致“不一致”，但再经过几轮的提议后，最终达成一致，确定某个value；

2、前一个proposer的prepare request可能会被另一个proposer的prepare request直接取消，从而提出了一个更高提议号的prepare request，但又取消了另一个刚提出的prepare，这样不断的相互取消就产生了活锁（对于活锁，我的理解是它不像死锁，陷入相互等待资源，必须等新资源补充；活锁是只要其中一个proposer稍缓或者停下来，就可以恢复正常，因为活锁产生的原因在于：高轮数的提议可以抢占低轮数的提议，而这又恰恰是为了防止死锁的产生）

所以为避免活锁，可规定只有一个proposer可以提议，这个proposer即为distinguished proposer（但这样不是变成类似于只有一个提议者，然后提议之后再广播给所有的模式了吗？还需要共识吗？老师：共识的关键在于又多个acceptor，而不是又多个proposer）

3、选择值过程中，**后者认同前者**，防止出现后者提出的新值覆盖原有被批准的旧值，始终无法达成一致

##### 学习值

选择值之后，只有大多数（majority）的acceptor接受了值，学习值过程，即将选中的值告知所有的learner；

默认是这大多数的acceptor会给所有的learner发送值，所以消息总数为nums of majority acceptor * num of learner，网络占用较大，所以可以选择某一个learner为distinguished learner，这大多数的acceptor将值发给distinguished  learner，该learner收到大多数acceptor的值后会向剩余的所有learner发送该值，消息总数为nums of majority  acceptor + nums of learner；

实践中，选择某进程，该进程的proposer成为distinguished proposer，learner成为distinguished learner，这个被选中的进程即为**leader**





#### Multi Paxos（paxos algorithm / state machine）

等同于paxos consensus的多次执行，每次paxos consensus的执行即为一个实例，每个实例拥有一个实例编号

1、独立实例的paxos

2、共用第一次prepare的paxos



#### 复制状态机 replicated deterministic state machine





目前问题：paxos的应用 -- 选择值和学习值具体怎么用到分布式场景，多个acceptor达成共识然后呢？复制状态机让多个副本之间的命令顺序一致，paxos具体怎么做到？？

![PaxosQuestion1](F:\Markdown\研一上\图片\PaxosQuestion1.png)